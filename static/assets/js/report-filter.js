const tableData = `{
    "total": 12 ,
    "rows": [
        {
            "id": 4,
            "project_id": 3,
            "test_uid": "06bccf22-38c9-4a9d-889f-07ed76542d9e",
            "name": "PetsDemoKaren1",
            "parallel": 1,
            "region": "default",
            "bucket": "",
            "file": "",
            "entrypoint": "Petclinic.jmx",
            "runner": "getcarrier/perfmeter:latest-5.3",
            "emails": "karen_florykian@epam.com",
            "env_vars": {},
            "customization": {},
            "cc_env_vars": {},
            "last_run": null,
            "job_type": "perfmeter"
        },
        {
            "id": 123,
            "project_id": 3,
            "test_uid": "06bccf22-38c9-4a9d-889f-07ed76542d9e",
            "name": "PetsDemoKaren1",
            "parallel": 1,
            "region": "default",
            "bucket": "",
            "file": "",
            "entrypoint": "Petclinic.jmx",
            "runner": "getcarrier/perfmeter:latest-5.3",
            "emails": "karen_florykian@epam.com",
            "env_vars": {},
            "customization": {},
            "cc_env_vars": {},
            "last_run": null,
            "job_type": "perfmeter"
        },
        {
            "id": 4435,
            "project_id": 3,
            "test_uid": "06bccf22-38c9-4a9d-889f-07ed76542d9e",
            "name": "PetsDemoKaren1",
            "parallel": 1,
            "region": "default",
            "bucket": "",
            "file": "",
            "entrypoint": "Petclinic.jmx",
            "runner": "getcarrier/perfmeter:latest-5.3",
            "emails": "karen_florykian@epam.com",
            "env_vars": {},
            "customization": {},
            "cc_env_vars": {},
            "last_run": null,
            "job_type": "perfmeter"
        },
        {
            "id": 454,
            "project_id": 3,
            "test_uid": "06bccf22-38c9-4a9d-889f-07ed76542d9e",
            "name": "PetsDemoKaren1",
            "parallel": 1,
            "region": "default",
            "bucket": "",
            "file": "",
            "entrypoint": "Petclinic.jmx",
            "runner": "getcarrier/perfmeter:latest-5.3",
            "emails": "karen_florykian@epam.com",
            "env_vars": {},
            "customization": {},
            "cc_env_vars": {},
            "last_run": null,
            "job_type": "perfmeter"
        },
        {
            "id": 4211,
            "project_id": 3,
            "test_uid": "06bccf22-38c9-4a9d-889f-07ed76542d9e",
            "name": "PetsDemoKaren1",
            "parallel": 1,
            "region": "default",
            "bucket": "",
            "file": "",
            "entrypoint": "Petclinic.jmx",
            "runner": "getcarrier/perfmeter:latest-5.3",
            "emails": "karen_florykian@epam.com",
            "env_vars": {},
            "customization": {},
            "cc_env_vars": {},
            "last_run": null,
            "job_type": "perfmeter"
        },
        {
            "id": 1231234,
            "project_id": 3,
            "test_uid": "06bccf22-38c9-4a9d-889f-07ed76542d9e",
            "name": "PetsDemoKaren1",
            "parallel": 1,
            "region": "default",
            "bucket": "",
            "file": "",
            "entrypoint": "Petclinic.jmx",
            "runner": "getcarrier/perfmeter:latest-5.3",
            "emails": "karen_florykian@epam.com",
            "env_vars": {},
            "customization": {},
            "cc_env_vars": {},
            "last_run": null,
            "job_type": "perfmeter"
        },
        {
            "id": 434643,
            "project_id": 3,
            "test_uid": "06bccf22-38c9-4a9d-889f-07ed76542d9e",
            "name": "PetsDemoKaren1",
            "parallel": 1,
            "region": "default",
            "bucket": "",
            "file": "",
            "entrypoint": "Petclinic.jmx",
            "runner": "getcarrier/perfmeter:latest-5.3",
            "emails": "karen_florykian@epam.com",
            "env_vars": {},
            "customization": {},
            "cc_env_vars": {},
            "last_run": null,
            "job_type": "perfmeter"
        },
        {
            "id": 3,
            "project_id": 3,
            "test_uid": "592cc59f-c09d-4026-83e2-2d0be768b1b4",
            "name": "TestDistributed",
            "parallel": 1,
            "region": "default",
            "bucket": "tests",
            "file": "Archive_flood.zip",
            "entrypoint": "FloodIO.jmx",
            "runner": "getcarrier/perfmeter:latest-5.3",
            "emails": "mykhailo_hunko@epam.com",
            "env_vars": {},
            "customization": {},
            "cc_env_vars": {},
            "git": {},
            "last_run": null,
            "job_type": "perfmeter"
        },
        {
            "id": 2,
            "project_id": 3,
            "test_uid": "4d4ea128-f32d-4bc4-a48d-1a4ac7053b03",
            "name": "PetsDemo",
            "parallel": 1,
            "region": "default",
            "bucket": "",
            "file": "",
            "entrypoint": "Petclinic.jmx",
            "runner": "getcarrier/perfmeter:latest-5.3",
            "emails": "karen_florykian@epam.com",
            "env_vars": {},
            "customization": {},
            "cc_env_vars": {},
            "last_run": null,
            "job_type": "perfmeter"
        }, {
            "id": 5,
            "project_id": 3,
            "test_uid": "06bccf22-38c9-4a9d-889f-07ed76542d9e",
            "name": "PetsDemoKaren1",
            "parallel": 1,
            "region": "default",
            "bucket": "",
            "file": "",
            "entrypoint": "Petclinic.jmx",
            "runner": "getcarrier/perfmeter:latest-5.3",
            "emails": "karen_florykian@epam.com",
            "env_vars": {},
            "customization": {},
            "cc_env_vars": {},
            "last_run": null,
            "job_type": "perfmeter"
        },
        {
            "id": 1,
            "project_id": 3,
            "test_uid": "592cc59f-c09d-4026-83e2-2d0be768b1b4",
            "name": "TestDistributed",
            "parallel": 1,
            "region": "default",
            "bucket": "tests",
            "file": "Archive_flood.zip",
            "entrypoint": "FloodIO.jmx",
            "runner": "getcarrier/perfmeter:latest-5.3",
            "emails": "mykhailo_hunko@epam.com",
            "env_vars": {},
            "customization": {},
            "cc_env_vars": {},
            "git": {},
            "last_run": null,
            "job_type": "perfmeter"
        },
        {
            "id": 6,
            "project_id": 3,
            "test_uid": "4d4ea128-f32d-4bc4-a48d-1a4ac7053b03",
            "name": "PetsDemo",
            "parallel": 1,
            "region": "default",
            "bucket": "",
            "file": "",
            "entrypoint": "Petclinic.jmx",
            "runner": "getcarrier/perfmeter:latest-5.3",
            "emails": "karen_florykian@epam.com",
            "env_vars": {},
            "customization": {},
            "cc_env_vars": {},
            "last_run": null,
            "job_type": "perfmeter"
        }
    ]
}`

const filtersData = [
    {
        id: 1,
        title: 'First',
        options: [
            {
                id: 1,
                column: 'Description',
                operator: 'Relish',
                title: 'knowlege',
            },
            {
                id: 2,
                column: 'Ketchup',
                operator: 'Mustard',
                title: 'Lorem ipsum',
            }
        ]
    },
    {
        id: 2,
        title: 'User filter 2',
        options: [
            {
                id: 2,
                column: 'Description',
                operator: 'Ketchup',
                title: 'knowlege',
            }
        ]
    },
    {
        id: 3,
        title: 'Two',
        options: [
            {
                id: 3,
                column: '',
                operator: '',
                title: 'knowlege',
            }
        ]
    }
]

const fetch = new Promise(resolve => {
    setTimeout(() => {
        resolve(filtersData)
    }, 1000)
})

const requestSave = (filterName) => {
    console.log(filterName)
    return  new Promise((resolve, reject) => {
        const isNameExist = filtersData.some(filter => filter.title.toLowerCase() === filterName.toLowerCase().trim())
        if (isNameExist) {
            reject('Filter name already exist')
        } else (resolve('Filter saved'))
    })
}

const ChooseFilter = {
    data() {
        return {
            filters: null,
            selectedFilter: {},
            loadingFilters: false,
        }
    },
    mounted() {
        this.fetchFilters();
    },
    methods: {
        fetchFilters() {
            this.loadingFilters = true;
            fetch.then(res => {
                this.filters = res;
                this.$emit('setFilters', this.filters)
            }).finally(() => {
                this.loadingFilters = false;
            })
        },
        selectFilter(filter) {
            this.selectedFilter = Object.assign({}, filter);
            this.$emit('setFilter', filter)
        },
        createFilter() {
            this.selectedFilter = {
                id: Math.round(Math.random() * 1000),
                title: '',
                options: [
                    {
                        id: Math.round(Math.random() * 1000),
                        column: '',
                        operator: '',
                        title: '',
                    }
                ]
            },
            this.$emit('setFilter', this.selectedFilter)
        }
    },
    template:`
        <div class="dropdown dropleft dropdown_action mr-2">
            <button class="btn dropdown-toggle btn-secondary"
                    role="button"
                    id="dropdownMenuLink"
                    data-toggle="dropdown"
                    aria-expanded="false">
                <i v-if="loadingFilters" class="preview-loader"></i>
                <i v-else class="fas fa-filter"></i>
            </button>

            <ul class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                <li class="dropdown-item" @click="createFilter">Create new</li>
                <li v-for="filter in filters" class="dropdown-item" @click="selectFilter(filter)">
                    <i class='fa fa-trash mr-2'></i>
                    {{ filter.title }}
                </li>
            </ul>
        </div>
    `
}

const modalSaveFilter = {
    props: ['filtersName'],
    data() {
        return {
            filterName: '',
            loading: false,
        }
    },
    computed: {
        hasError() {
            return this.isShortName();
        }
    },
    methods: {
        isShortName() {
            return this.filterName.length < 3;
        },
        saveFilter() {
            this.loading = true;
            setTimeout(() => {
                requestSave(this.filterName).then(response => {
                    this.$emit('save-filter-as');
                    showNotify('SUCCESS', 'Filter saved');
                }).catch(error => {
                    showNotify('ERROR', error);
                }).finally(() => {
                    this.loading = false;
                })
            }, 500)
        }
    },
    template:`
        <div class="modal-component">
            <div class="modal-card">
                <p class="font-bold font-h3 mb-4">Create filter</p>
                <div class="custom-input" :class="{'invalid-input': hasError}">
                    <input
                        type="text"
                        v-model="filterName"
                        placeholder="Text">
                    <span class="input_error-msg">Filter name less then 3 letters</span>
                    <div class="d-flex justify-content-end mt-4">
                        <button type="button" class="btn btn-secondary mr-2" @click="$emit('save-filter-as')">Reset</button>
                        <button
                            :disabled="hasError"
                            class="btn btn-basic mr-2 d-flex align-items-center"
                            :class="{'btn-secondary': loading}"
                            type="submit"
                            @click="saveFilter"
                        >Save <i v-if="loading" class="preview-loader"></i></button>
                    </div>
                </div>
            </div>
        </div>
    `
}

const ReportFilter = {
    props: ['filter'],
    data() {
        return {
            editableFilter: {},
        }
    },
    mounted() {
        this.editableFilter = this.deepClone(this.filter);
        this.renderSelect();
    },
    methods: {
        deepClone(obj) {
            if (obj === null) return null;
            let clone = Object.assign({}, obj);
            Object.keys(clone).forEach(
                key =>
                    (clone[key] =
                        typeof obj[key] === 'object' ? this.deepClone(obj[key]) : obj[key])
            );
            if (Array.isArray(obj)) {
                clone.length = obj.length;
                return Array.from(clone);
            }
            return clone;
        },
        renderSelect() {
            this.$nextTick(() => {
                $('.selectpicker').selectpicker('render');
            });
        },
        addOption() {
            this.editableFilter.options.push({
                id: Math.round(Math.random() * 1000),
                column: '',
                operator: '',
                title: '',
            })
            this.renderSelect();
        },
        removeOption(optionId) {
            this.editableFilter.options = this.editableFilter.options.filter(elem => elem.id !== optionId);
        },
        removeFilter() {
            this.$emit('remove-filter');
        },
        resetFilter() {
            this.editableFilter = this.deepClone(this.filter);
        }
    },
    template:`
        <div class="report-filter">
            <div class="d-flex justify-content-between mt-4 mb-2 pr-4">
                <p class="font-h5 font-bold">New Filter</p>
                <a class="notification-close" @click="removeFilter"></a>
            </div>
            <table class="w-100 table-filter mb-3" id="table-filter">
                <thead>
                <tr class="font-h6">
                    <th>Column</th>
                    <th>Operator</th>
                    <th>Data</th>
                </tr>
                </thead>
                <tr v-for="option in editableFilter.options" :key="option.id">
                    <td class="pr-2 pb-2">
                        <select class="selectpicker min-w-100 bootstrap-select__b" data-style="btn" v-model="option.column">
                            <option>Mustard</option>
                            <option>Ketchup</option>
                            <option>Relish</option>
                            <option>Description</option>
                        </select>
                    </td>
                    <td class="pr-2 pb-2">
                        <select class="selectpicker min-w-100 bootstrap-select__b" data-style="btn" v-model="option.operator">
                            <option>Mustard</option>
                            <option>Ketchup</option>
                            <option>Relish</option>
                        </select>
                    </td>
                    <td class="w-100 pb-2">
                        <div class="custom-input">
                            <input
                                type="text"
                                v-model="option.title"
                                placeholder="Some data">
                        </div>
                    </td>
                    <td>
                        <div class="d-flex justify-content-end table-action align-items-center pl-2 pr-4">
                            <button 
                                v-if="editableFilter.options.length > 1"
                                type="button" class="btn btn-24 btn-action"
                                @click="removeOption(option.id)"><i class="fas fa-minus"></i>
                             </button>
                            <button type="button" class="btn btn-24 btn-action" @click="addOption"><i class="fas fa-plus"></i></button>
                        </div>
                    </td>
                </tr>
            </table>
            <div class="mb-4">
                <button class="btn btn-basic mr-2" type="submit">Apply</button>
                <button type="button" class="btn btn-secondary mr-2" @click="resetFilter">Reset</button>
                <button class="btn btn-default mr-2">Save</button>
                <button class="btn btn-default" @click="$emit('save-filter-as')">Save as...</button>
            </div>
        </div>
    `
}

const vueApp = Vue.createApp({
    components: {
        'report-filter': ReportFilter,
        'choose-filter': ChooseFilter,
        'modal-save-filter': modalSaveFilter,
        'bootstrap-table': BootstrapTable,
    },
    data() {
        return {
            currentFilter: null,
            showModal: false,
            filtersName: [],
            tableData: null,
            loading: false,
        }
    },
    mounted() {
        this.fetchTableData();
    },
    methods: {
        fetchTableData() {
            // window.$table.bootstrapTable('load', tableData);
        },
        setFilter(filter) {
            this.currentFilter = filter;
        },
        setFilters(filters) {
            this.filtersName = filters.map(filter => filter.title);
        },
        saveFilterAs() {
            this.showModal = !this.showModal;
        }
    }
});

vueApp.mount('#vueApp');